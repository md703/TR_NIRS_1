# ANN fitting
Generate target spectra/DTOFs and fitting them.

---
## Prepare
* An ANN for each subject that inputs the OPs of each layers and output reflectance spectra and DTOFs for each SDSs.  
* The boundary of each tissue parameter.

---

## Background

To make the optical parameters (OPs) meaningful continuous in each wavelength, I use tissue parameters to describe the OPs of each layer.  
The tissue parameters including:
* For mua: the concentration of each absorber, e.g., hemoglobin (hemoglobin concentration (hc) and tissue oxygen saturation (StO2) are used to calculate the concentation of oxyhemoglobin and deoxyhemoglobin) and melanin.
    * The true mua is calculated by multiply the absorption coefficient of each absorber by the their concentraiton.
* For mus: A and K are used to describe the scattering coefficient.
    * $\mu_s'(\lambda)=A\times\lambda^{-k}$
    * $\mu_s=\mu_s'/(1-g)$

---

## 1. Make initial value database
Because the fitting needs a initial value to begin with, we need to use a database to choose which initial value(s) is better. The database(DB) contains many sets of tissue parameters (which describe the OPs for each layer) and the corresponding spectra. Before fitting, the program will compare all spectra in the database to the target spectrum, and choose the tissue parameters with the smallest spectral error as the initial value of fitting.

### 1.1. Find AK boundary

Before make the DB, since the mus is describe by A and K, which is a nonlinear relationship, we should make sure the calculated mus is not exceed the mus boundary(of the ANN).


Use `S0_find_AK_range.m` to find the boundary.

You should give the name of the ANN models and the dir of the ANN models, also the g value and wavelength range you will used to fitting.
```matlab=11
subject_name_arr={'ZJ','WW2','YF','YH','WH2','KB','SJ','BT','SC'}; % the name of the subjects
g=0.9; % g for L1,2,4
target_spec_wl=(700:900)';
fitting_wl_tr=800;

model_folder='model_arrange'; % the folder of the models
```
Then the program will load the ANN model, find the mus boundary of the ANN, and auto calculate the range of A and K.

### 1.2. Make database

Use `S1_0_gen_init_value_for_db.m` and `S1_make_database.m` to make the database.

## 2. Generate testing spectra

To generat the testing spectrum, you should use `T2_generate_target_paramAnswer.m`.  

In the program, you should give:
* `num_anser_to_generate`: the number of random parameter to generate. For example, there will be 15 random answer to fitting for each subejct.  
* `num_error_to_generate`: the number of error to add to each testing spectrum. Since the invivo measurement will have some noise, we should add these noise to the target spectrum(otherwise will have no noise, since it's generated by ANN). The first one will be no error. For example, `num_error_to_generate=15` means there will be 1 spectrum with no noise and 14 spectra with error.

For adding noise to spectra:
* `SDS_error_arr` is the CV of each SDS when you measure the phantom or subject.
* `use_slope_mode` is used if you want to generate the noise representing the invivo noise. Since I found that the invivo nosie will be differnet in each wavelength, the flag `use_slope_mode=1` will let the program generate different error for each wavelength. Otherwile, `use_slope_mode=0` will generate the same noise for each wavelength to represent the noise while measure phantom, which is the system noise.
* `small_noise_ratio` will generate additional small noise in each wavelength.

For adding noise to DTOFs:
* `cv_value_1E11.mat` is the CV of each SDS and gate for simulation, you can replace with the value you want to add.


After generate the target spectra, you can use `T2_2_plot_generated_spec.m` and `T2_3_plot_generated_OP.m` can be used to plot the generated spectra and DTOFs(with differnet noise) and the OP answers.

## 3. Fitting testing target spectra

### 3.1. Fitting
Use `T3_main_fitting_generated_target.m` to fitting the generated spectra.

You should give:
* `times_to_fitting`: how many initial values are used to fitting. Use more than only 1 initial value to prevent local minima.
* `input_dir`: the folder containing the testing spectra you just generated.

For continuous-wave:
* `cw_flag`: 1=take the spectra as the fitted target.
* `SDS_choosed_cw`: Which SDS you choose to fitting. The program will only calculate the error of these SDSs and use the error to optimize the OPs.

For time-resolved:
* `tr_flag`: 1=take the DTOFs as the fitted target.
* `SDS_choosed_tr`: Which SDS you choose to fitting. The program will only calculate the error of these SDSs and use the error to optimize the OPs.
* `choose_gate_flag`: 1=manually choose the fitted gate(you should set the `gate_choosed`), 0=automatically choose the fitting range start from 50% of the ascending to 0.01% of the descending part.
* `gate_weight_flag`: 1=add different weight to each gate.You should set `weight_SDS`,`weight_gate`(which SDS and gate to add weight),`weight_value`(default value is 1, you can decide the weighting value.)

For fitting both data:
* `sys_weight_flag`: to add different weight to the fitting error of CW and TR data or not. 0=weight between two system is 1:1. 1=adding weights depends on the given data size of each system.


After the fitting is done, you can use `T3_2_check_fitting_complete.m` to chech of all the fitting are done. Sometimes there will be some error for some initial value, make sure you had run `S1_2_database_refine.m` if you had change the fitting wl. Otherwise, you can use `T3_main_fitting_generated_target.m` to fitting again, the program will skip the target which had been done automatically.

### 3.2. Arrange the fitting result

Use `T4_fitting_result_arrange.m` to arrange the fitting result.  

You should give:
* `input_dir`: The folder that contains the generated targets.
* `fitting_dir`: the folder that `T3_main_fitting_generated_target.m` create automatically for each SDS combination.

The program will arrange the fitting result of multiple initial values, and find which fitting have the smallist error for choosed SDSs.

There will be one .csv file for each target
![](https://i.imgur.com/xVuzNzH.png)

### 3.3. Result analysis

You can use `T5_cal_bestFitting_opError_percentile.m` to calculate the OP error percentile for each rank's fitting result.
![](https://i.imgur.com/d29euxI.png)

Then you can use `T6_cal_mean_OPerror.m`, `T7_arrange_OPerror.m` to plot error distribution, mean, and standard of the OP fitted result.

